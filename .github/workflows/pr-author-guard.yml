name: PR Author Guard (block code PRs from non-approved authors)
on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Block unapproved authors for code changes
        env:
          AUTHOR: ${{ github.event.pull_request.user.login }}
          # ‚úÖ ÌóàÏö© ÏûëÏÑ±Ïûê Î™©Î°ù(Ïä§ÌéòÏù¥Ïä§ Íµ¨Î∂Ñ): ÌïÑÏöîÏãú Ïó¨Í∏∞Îßå ÏàòÏ†ï
          APPROVED: "catherinehlab CursorDev ClaudeCode github-actions[bot]"
          # üö´ Î™ÖÏãúÏ†Å Ï∞®Îã® ÏûëÏÑ±Ïûê Î™©Î°ù
          BLOCKED: "ChatGPT5-bot ChatGPT5"
          REPO: ${{ github.repository }}
          PR: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # 1) ChatGPT5 Îì± Ï∞®Îã®Îêú ÏûëÏÑ±Ïûê Ï≤¥ÌÅ¨
          for b in $BLOCKED; do
            if [ "$AUTHOR" = "$b" ]; then
              echo "‚ùå Author '$AUTHOR' is explicitly blocked from submitting any changes."
              exit 1
            fi
          done

          # 2) ÏûëÏÑ±Ïûê ÌóàÏö©Ïù¥Î©¥ ÌÜµÍ≥º
          for a in $APPROVED; do
            if [ "$AUTHOR" = "$a" ]; then
              echo "Author allowed: $AUTHOR"
              exit 0
            fi
          done

          # 3) Î≥ÄÍ≤Ω ÌååÏùº Î™©Î°ù Ï°∞Ìöå
          curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/pulls/$PR/files?per_page=200" > files.json

          # 4) ÎπÑÏΩîÎìú Î≥ÄÍ≤ΩÎßå(Î¨∏ÏÑú/ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÑ§Ï†ï/README)Ïù∏ Í≤ΩÏö∞Îäî ÏòàÏô∏Ï†ÅÏúºÎ°ú ÌÜµÍ≥º
          if ! grep -E '"filename":' files.json | grep -vE 'docs/|clients/|README\.md' >/dev/null; then
            echo "Docs/clients-only changes by non-approved author ‚Üí allowed."
            exit 0
          fi

          echo "‚ùå PR author '$AUTHOR' is not allowed to submit code changes."
          exit 1
