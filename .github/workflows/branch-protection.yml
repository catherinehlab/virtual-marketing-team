name: Branch Protection - Block ChatGPT5 Code Changes
on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  push:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  protect-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Check if ChatGPT5 is attempting code changes
        id: check-author
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            AUTHOR="${{ github.event.pull_request.user.login }}"
            EVENT_TYPE="PR"
          else
            AUTHOR="${{ github.event.head_commit.author.name }}"
            EVENT_TYPE="Push"
          fi
          
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "event_type=$EVENT_TYPE" >> $GITHUB_OUTPUT
          
          # ChatGPT5 ê³„ì • ì²´í¬
          if [[ "$AUTHOR" == *"ChatGPT5"* ]] || [[ "$AUTHOR" == *"ChatGPT5-bot"* ]]; then
            echo "blocked=true" >> $GITHUB_OUTPUT
            echo "âŒ ChatGPT5 detected - blocking code changes"
          else
            echo "blocked=false" >> $GITHUB_OUTPUT
            echo "âœ… Author allowed: $AUTHOR"
          fi

      - name: Block ChatGPT5 PRs
        if: steps.check-author.outputs.blocked == 'true' && steps.check-author.outputs.event_type == 'PR'
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸš« Blocking ChatGPT5 PR #${{ github.event.pull_request.number }}"
          
          # PRì„ ìë™ìœ¼ë¡œ ë‹«ê³  ì°¨ë‹¨ ë©”ì‹œì§€ ì¶”ê°€
          BLOCK_MESSAGE="
          ## ğŸš« ChatGPT5 Code Changes Blocked
          
          **ChatGPT5ëŠ” ì½”ë“œ ë³€ê²½ì„ í—ˆìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**
          
          ### í—ˆìš©ëœ ì—­í• :
          - âœ… **ìš”êµ¬ì‚¬í•­ ìˆ˜ì§‘ ë° ë¶„ì„**
          - âœ… **ì‚¬ì–‘ ì „ë‹¬ ë° ì´ìŠˆ ìƒì„±**
          - âŒ **ì½”ë“œ ì‘ì„± ë° ìˆ˜ì •**
          
          ### ì˜¬ë°”ë¥¸ ì›Œí¬í”Œë¡œìš°:
          1. **ChatGPT5**: ìš”êµ¬ì‚¬í•­ ìˆ˜ì§‘ â†’ ì´ìŠˆ ìƒì„±
          2. **Gemini**: ìš”êµ¬ì‚¬í•­ ìš”ì•½
          3. **Claude**: íƒœìŠ¤í¬ ë¶„í•´ ë° ì˜ì‚¬ê²°ì •
          4. **Cursor**: ì‹¤ì œ ê°œë°œ ë° êµ¬í˜„
          
          ì´ PRì€ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤. ì˜¬ë°”ë¥¸ ì›Œí¬í”Œë¡œìš°ë¥¼ ë”°ë¼ì£¼ì„¸ìš”.
          "
          
          # PR ë‹«ê¸°
          curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -X PATCH \
            -d '{"state":"closed"}' \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}"
          
          # ì°¨ë‹¨ ë©”ì‹œì§€ ì¶”ê°€
          printf '{"body":%s}\n' "$(jq -Rsa . <<<"$BLOCK_MESSAGE")" > block_message.json
          curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d @block_message.json \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
          
          # PRì— ì°¨ë‹¨ ë¼ë²¨ ì¶”ê°€
          curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -X POST \
            -d '{"labels":["blocked","chatgpt5-violation"]}' \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels"

      - name: Block ChatGPT5 Direct Pushes
        if: steps.check-author.outputs.blocked == 'true' && steps.check-author.outputs.event_type == 'Push'
        run: |
          echo "ğŸš« ChatGPT5 direct push detected - this should not happen"
          echo "Branch protection rules should prevent this"
          exit 1

      - name: Allow Non-ChatGPT5 Changes
        if: steps.check-author.outputs.blocked == 'false'
        run: |
          echo "âœ… Allowing changes from: ${{ steps.check-author.outputs.author }}"
          echo "Proceeding with normal workflow..."
